


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ProfessionalScheduleService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">ec.gob.conagopare.sona.modules.appointments.service</a>
</div>

<h1>Coverage Summary for Class: ProfessionalScheduleService (ec.gob.conagopare.sona.modules.appointments.service)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ProfessionalScheduleService</td>
<td class="coverageStat">
  <span class="percent">
    66,7%
  </span>
  <span class="absValue">
    (4/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    83,3%
  </span>
  <span class="absValue">
    (20/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    86,3%
  </span>
  <span class="absValue">
    (44/51)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ProfessionalScheduleService$$SpringCGLIB$$0</td>
  </tr>
  <tr>
    <td class="name">ProfessionalScheduleService$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    62,5%
  </span>
  <span class="absValue">
    (5/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (13/13)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    75%
  </span>
  <span class="absValue">
    (6/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    78,1%
  </span>
  <span class="absValue">
    (25/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    89,1%
  </span>
  <span class="absValue">
    (57/64)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package ec.gob.conagopare.sona.modules.appointments.service;
&nbsp;
&nbsp;import ec.gob.conagopare.sona.modules.appointments.dto.ProfessionalScheduleDto;
&nbsp;import ec.gob.conagopare.sona.modules.appointments.dto.ProfessionalSchedulesDto;
&nbsp;import ec.gob.conagopare.sona.modules.appointments.models.ProfessionalSchedule;
&nbsp;import ec.gob.conagopare.sona.modules.appointments.repository.ProfessionalScheduleRepository;
&nbsp;import ec.gob.conagopare.sona.modules.user.models.Authority;
&nbsp;import ec.gob.conagopare.sona.modules.user.service.UserService;
&nbsp;import io.github.luidmidev.springframework.data.crud.core.services.hooks.CrudHooks;
&nbsp;import io.github.luidmidev.springframework.data.crud.jpa.services.JpaCrudService;
&nbsp;import io.github.luidmidev.springframework.web.problemdetails.ProblemDetails;
&nbsp;import jakarta.persistence.EntityManager;
&nbsp;import jakarta.validation.Valid;
&nbsp;import lombok.Getter;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.data.domain.Pageable;
&nbsp;import org.springframework.security.access.prepost.PreAuthorize;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import org.springframework.util.MultiValueMap;
&nbsp;
&nbsp;import java.time.*;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;
&nbsp;import static ec.gob.conagopare.sona.application.Constans.ECUADOR_ZONE;
&nbsp;
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Service
&nbsp;@RequiredArgsConstructor
&nbsp;@Getter
&nbsp;public class ProfessionalScheduleService implements JpaCrudService&lt;ProfessionalSchedule, ProfessionalScheduleDto, Long, ProfessionalScheduleRepository&gt; {
&nbsp;
&nbsp;    private static final int MAX_DAYS_RANGE = 365;
&nbsp;
&nbsp;    private final ProfessionalScheduleRepository repository;
&nbsp;    private final EntityManager entityManager;
&nbsp;    private final UserService userService;
&nbsp;
&nbsp;    @Override
&nbsp;    public Class&lt;ProfessionalSchedule&gt; getEntityClass() {
<b class="fc">&nbsp;        return ProfessionalSchedule.class;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void mapModel(ProfessionalScheduleDto dto, ProfessionalSchedule model) {
&nbsp;
<b class="fc">&nbsp;        var startDate = ZonedDateTime.of(dto.getDate(), LocalTime.of(dto.getFromHour(), 0), ECUADOR_ZONE);</b>
<b class="fc">&nbsp;        var nowInEcuador = ZonedDateTime.now(ECUADOR_ZONE);</b>
&nbsp;
<b class="fc">&nbsp;        if (startDate.isBefore(nowInEcuador)) {</b>
<b class="fc">&nbsp;            throw ProblemDetails.badRequest(&quot;La fecha de inicio no puede ser menor a la fecha actual&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        var user = userService.find(dto.getProfessionalId());</b>
&nbsp;
<b class="fc">&nbsp;        if (!user.isAny(Authority.LEGAL_PROFESSIONAL, Authority.MEDICAL_PROFESSIONAL)) {</b>
<b class="fc">&nbsp;            throw ProblemDetails.badRequest(&quot;El usuario no es un profesional, no puede tener horarios de atención&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        var isNew = model.isNew();</b>
<b class="fc">&nbsp;        var date = dto.getDate();</b>
<b class="fc">&nbsp;        var fromHour = dto.getFromHour();</b>
<b class="fc">&nbsp;        var toHour = dto.getToHour();</b>
<b class="fc">&nbsp;        var professionalId = dto.getProfessionalId();</b>
&nbsp;
<b class="fc">&nbsp;        var isOverlapping = isNew</b>
<b class="fc">&nbsp;                ? repository.existsOverlappingSchedule(professionalId, date, fromHour, toHour)</b>
<b class="fc">&nbsp;                : repository.existsOverlappingScheduleExcludingId(professionalId, date, fromHour, toHour, model.getId());</b>
&nbsp;
<b class="fc">&nbsp;        if (isOverlapping) {</b>
<b class="fc">&nbsp;            throw ProblemDetails.badRequest(&quot;El horario que intenta registrar se superpone con otro horario del profesional&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (!isNew &amp;&amp; repository.existsActiveAppointmentsInSchedule(professionalId, model.getDate(), model.getFromHour(), model.getToHour())) {</b>
<b class="fc">&nbsp;            throw ProblemDetails.badRequest(&quot;No se puede modificar un horario que tiene citas activas&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        model.setProfessional(user);</b>
<b class="fc">&nbsp;        model.setDate(date);</b>
<b class="fc">&nbsp;        model.setFromHour(fromHour);</b>
<b class="fc">&nbsp;        model.setToHour(toHour);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Page&lt;ProfessionalSchedule&gt; internalSearch(String search, Pageable pageable, MultiValueMap&lt;String, String&gt; params) {
<b class="nc">&nbsp;        throw ProblemDetails.badRequest(&quot;Filtro no soportado&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;ProfessionalSchedule&gt; getSchedulesByProfessional(Long professionalId, LocalDate from, LocalDate to) {
<b class="nc">&nbsp;        if (from.isAfter(to)) {</b>
<b class="nc">&nbsp;            throw ProblemDetails.badRequest(&quot;La fecha de inicio no puede ser mayor que la fecha de fin&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        var diff = to.toEpochDay() - from.toEpochDay();</b>
<b class="nc">&nbsp;        if (diff &gt; MAX_DAYS_RANGE) {</b>
<b class="nc">&nbsp;            throw ProblemDetails.badRequest(&quot;El rango de fechas no puede ser mayor a &quot; + MAX_DAYS_RANGE + &quot; años&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return repository.getSchedulesByProfessional(professionalId, from, to);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    @PreAuthorize(&quot;hasRole(&#39;admin&#39;)&quot;)
&nbsp;    public List&lt;ProfessionalSchedule&gt; createAll(@Valid ProfessionalSchedulesDto dto) {
<b class="fc">&nbsp;        var user = userService.find(dto.getProfessionalId());</b>
&nbsp;
<b class="fc">&nbsp;        if (!user.isAny(Authority.LEGAL_PROFESSIONAL, Authority.MEDICAL_PROFESSIONAL)) {</b>
<b class="fc">&nbsp;            throw ProblemDetails.badRequest(&quot;El usuario no es un profesional, no puede tener horarios de atención&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        var created = new ArrayList&lt;ProfessionalSchedule&gt;();</b>
<b class="fc">&nbsp;        for (var dates : dto.getDates()) {</b>
<b class="fc">&nbsp;            var startDate = ZonedDateTime.of(dates, LocalTime.of(dto.getFromHour(), 0), ECUADOR_ZONE);</b>
<b class="fc">&nbsp;            var nowInEcuador = ZonedDateTime.now(ECUADOR_ZONE);</b>
&nbsp;
<b class="fc">&nbsp;            if (startDate.isBefore(nowInEcuador)) {</b>
<b class="fc">&nbsp;                throw ProblemDetails.badRequest(&quot;La fecha de inicio no puede ser menor a la fecha actual&quot;);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            var isOverlapping = repository.existsOverlappingSchedule(dto.getProfessionalId(), dates, dto.getFromHour(), dto.getToHour());</b>
&nbsp;
<b class="fc">&nbsp;            if (isOverlapping) {</b>
<b class="fc">&nbsp;                throw ProblemDetails.badRequest(&quot;Al menos uno de los horarios que intenta registrar se superpone con otro horario del profesional&quot;);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            var schedule = new ProfessionalSchedule();</b>
<b class="fc">&nbsp;            schedule.setProfessional(user);</b>
<b class="fc">&nbsp;            schedule.setDate(dates);</b>
<b class="fc">&nbsp;            schedule.setFromHour(dto.getFromHour());</b>
<b class="fc">&nbsp;            schedule.setToHour(dto.getToHour());</b>
&nbsp;
<b class="fc">&nbsp;            created.add(repository.save(schedule));</b>
&nbsp;        }
<b class="fc">&nbsp;        return created;</b>
&nbsp;    }
&nbsp;
&nbsp;
<b class="fc">&nbsp;    private final CrudHooks&lt;ProfessionalSchedule, ProfessionalScheduleDto, Long&gt; hooks = new CrudHooks&lt;&gt;() {</b>
&nbsp;        @Override
&nbsp;        public void onBeforeDelete(ProfessionalSchedule model) {
<b class="fc">&nbsp;            var toHour = model.getToHour();</b>
<b class="fc">&nbsp;            var fromHour = model.getFromHour();</b>
&nbsp;
<b class="pc">&nbsp;            var date = toHour == 24 ? model.getDate().plusDays(1) : model.getDate();</b>
<b class="pc">&nbsp;            var time = toHour == 24 ? LocalTime.of(0, 0) : LocalTime.of(toHour, 0);</b>
&nbsp;
<b class="fc">&nbsp;            var endDate = ZonedDateTime.of(date, time, ECUADOR_ZONE);</b>
<b class="fc">&nbsp;            var nowInEcuador = ZonedDateTime.now(ECUADOR_ZONE);</b>
&nbsp;
<b class="pc">&nbsp;            if (endDate.isBefore(nowInEcuador)) return;</b>
&nbsp;
<b class="fc">&nbsp;            boolean hasActiveAppointments = repository.existsActiveAppointmentsInSchedule(</b>
<b class="fc">&nbsp;                    model.getProfessional().getId(),</b>
<b class="fc">&nbsp;                    model.getDate(),</b>
&nbsp;                    fromHour,
&nbsp;                    toHour
&nbsp;            );
&nbsp;
<b class="fc">&nbsp;            if (hasActiveAppointments) {</b>
<b class="fc">&nbsp;                throw ProblemDetails.badRequest(&quot;No se puede eliminar un horario que tiene citas activas&quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    };
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-02-21 14:48</div>
</div>
</body>
</html>
