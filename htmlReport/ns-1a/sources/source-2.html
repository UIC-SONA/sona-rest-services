


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TipService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">ec.gob.conagopare.sona.modules.content.services</a>
</div>

<h1>Coverage Summary for Class: TipService (ec.gob.conagopare.sona.modules.content.services)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TipService</td>
<td class="coverageStat">
  <span class="percent">
    57,1%
  </span>
  <span class="absValue">
    (8/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    83,3%
  </span>
  <span class="absValue">
    (5/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    77,1%
  </span>
  <span class="absValue">
    (37/48)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TipService$$SpringCGLIB$$0</td>
  </tr>
  <tr>
    <td class="name">TipService$1</td>
<td class="coverageStat">
  <span class="percent">
    66,7%
  </span>
  <span class="absValue">
    (2/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    75%
  </span>
  <span class="absValue">
    (3/4)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    58,8%
  </span>
  <span class="absValue">
    (10/17)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    75%
  </span>
  <span class="absValue">
    (6/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    76,9%
  </span>
  <span class="absValue">
    (40/52)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package ec.gob.conagopare.sona.modules.content.services;
&nbsp;
&nbsp;import ec.gob.conagopare.sona.application.common.utils.FileUtils;
&nbsp;import ec.gob.conagopare.sona.application.common.utils.StorageUtils;
&nbsp;import ec.gob.conagopare.sona.modules.content.dto.TipDto;
&nbsp;import ec.gob.conagopare.sona.modules.content.models.Tip;
&nbsp;import ec.gob.conagopare.sona.modules.content.models.TipRate;
&nbsp;import ec.gob.conagopare.sona.modules.content.repositories.TipRepository;
&nbsp;import ec.gob.conagopare.sona.modules.content.repositories.TipValuationRepository;
&nbsp;import ec.gob.conagopare.sona.modules.user.service.NotificationService;
&nbsp;import ec.gob.conagopare.sona.modules.user.service.UserService;
&nbsp;import io.github.luidmidev.springframework.data.crud.core.exceptions.NotFoundEntityException;
&nbsp;import io.github.luidmidev.springframework.data.crud.core.services.hooks.CrudHooks;
&nbsp;import io.github.luidmidev.springframework.data.crud.jpa.services.JpaCrudService;
&nbsp;import io.github.luidmidev.springframework.web.problemdetails.ProblemDetails;
&nbsp;import io.github.luidmidev.storage.Storage;
&nbsp;import io.github.luidmidev.storage.Stored;
&nbsp;import jakarta.persistence.EntityManager;
&nbsp;import lombok.Getter;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.hibernate.validator.constraints.Range;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.data.domain.Pageable;
&nbsp;import org.springframework.security.access.prepost.PreAuthorize;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.util.LinkedMultiValueMap;
&nbsp;import org.springframework.util.MultiValueMap;
&nbsp;import org.springframework.web.multipart.MultipartFile;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.List;
&nbsp;import java.util.UUID;
&nbsp;
&nbsp;import static java.util.Optional.*;
&nbsp;
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Service
&nbsp;@Getter
&nbsp;@RequiredArgsConstructor
&nbsp;public class TipService implements JpaCrudService&lt;Tip, TipDto, UUID, TipRepository&gt; {
&nbsp;
&nbsp;    private static final String TIPS_IMAGES_PATH = &quot;tips&quot;;
&nbsp;
&nbsp;    private final TipRepository repository;
&nbsp;    private final EntityManager entityManager;
&nbsp;    private final TipValuationRepository valuationRepository;
&nbsp;    private final Storage storage;
&nbsp;    private final NotificationService notificationService;
&nbsp;    private final UserService userService;
&nbsp;
&nbsp;    @Override
&nbsp;    public void mapModel(TipDto dto, Tip model) {
<b class="fc">&nbsp;        var image = dto.getImage();</b>
<b class="fc">&nbsp;        if (image != null) {</b>
&nbsp;            try {
<b class="fc">&nbsp;                if (model.isNew()) {</b>
<b class="fc">&nbsp;                    setImage(model, image);</b>
&nbsp;                } else {
<b class="fc">&nbsp;                    var oldImage = model.getImage();</b>
<b class="fc">&nbsp;                    setImage(model, image);</b>
<b class="fc">&nbsp;                    StorageUtils.tryRemoveFileAsync(storage, oldImage);</b>
&nbsp;                }
&nbsp;            } catch (IOException e) {
<b class="fc">&nbsp;                throw ProblemDetails.internalServerError(&quot;Error al guardar la imagen: &quot; + e.getMessage());</b>
&nbsp;            }
<b class="pc">&nbsp;        } else if (model.isNew()) {</b>
<b class="fc">&nbsp;            throw ProblemDetails.badRequest(&quot;La imagen es requerida&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        model.setTitle(dto.getTitle());</b>
<b class="fc">&nbsp;        model.setSummary(dto.getSummary());</b>
<b class="fc">&nbsp;        model.setDescription(dto.getDescription());</b>
<b class="fc">&nbsp;        model.setTags(dto.getTags());</b>
<b class="fc">&nbsp;        model.setActive(dto.isActive());</b>
&nbsp;    }
&nbsp;
&nbsp;    @PreAuthorize(&quot;isAuthenticated()&quot;)
&nbsp;    public Page&lt;Tip&gt; actives(String search, Pageable pageable) {
<b class="nc">&nbsp;        var currentUser = userService.getCurrentUser();</b>
<b class="nc">&nbsp;        return repository.searchAllWithRates(search, currentUser.getId(), true, pageable);</b>
&nbsp;    }
&nbsp;
&nbsp;    @PreAuthorize(&quot;isAuthenticated()&quot;)
&nbsp;    public Stored image(UUID id) throws IOException {
<b class="nc">&nbsp;        var imagePath = repository.getImagePathById(id).orElseThrow(() -&gt; new NotFoundEntityException(getEntityClass(), id));</b>
<b class="nc">&nbsp;        return storage.download(imagePath).orElseThrow(() -&gt; ProblemDetails.notFound(&quot;No se encontr√≥ la imagen&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @PreAuthorize(&quot;hasRole(&#39;admin&#39;)&quot;)
&nbsp;    public void deleteImage(UUID id) {
<b class="fc">&nbsp;        var tip = repository.findById(id).orElseThrow(() -&gt; new NotFoundEntityException(getEntityClass(), id));</b>
<b class="fc">&nbsp;        var imagePath = tip.getImage();</b>
<b class="fc">&nbsp;        tip.setImage(null);</b>
<b class="fc">&nbsp;        repository.save(tip);</b>
<b class="fc">&nbsp;        StorageUtils.tryRemoveFileAsync(storage, imagePath);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @PreAuthorize(&quot;isAuthenticated()&quot;)
&nbsp;    public void rate(UUID id, @Range(min = 1, max = 5) int value) {
<b class="fc">&nbsp;        var currentUser = userService.getCurrentUser();</b>
<b class="fc">&nbsp;        var tip = find(id);</b>
&nbsp;
<b class="fc">&nbsp;        var valuationEntity = valuationRepository.findByTipIdAndUserId(id, currentUser.getId())</b>
<b class="fc">&nbsp;                .orElseGet(() -&gt; TipRate.builder()</b>
<b class="fc">&nbsp;                        .tip(tip)</b>
<b class="fc">&nbsp;                        .user(currentUser)</b>
<b class="fc">&nbsp;                        .valuationDate(LocalDateTime.now())</b>
<b class="fc">&nbsp;                        .build());</b>
&nbsp;
<b class="fc">&nbsp;        valuationEntity.setValue(value);</b>
<b class="fc">&nbsp;        valuationRepository.save(valuationEntity);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setImage(Tip model, MultipartFile image) throws IOException {
<b class="fc">&nbsp;        var fileName = FileUtils.factoryDateTimeFileName(&quot;tip-img-&quot;, image.getOriginalFilename());</b>
<b class="fc">&nbsp;        var path = storage.store(image.getInputStream(), fileName, TIPS_IMAGES_PATH);</b>
<b class="fc">&nbsp;        model.setImage(path);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Tip internalFind(UUID uuid) {
<b class="fc">&nbsp;        var currentUser = userService.getCurrentUser();</b>
<b class="fc">&nbsp;        return repository.findByIdWithRates(uuid, currentUser.getId()).orElseThrow(() -&gt; new NotFoundEntityException(getEntityClass(), uuid));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Page&lt;Tip&gt; internalPage(Pageable pageable) {
<b class="nc">&nbsp;        var currentUser = userService.getCurrentUser();</b>
<b class="nc">&nbsp;        return repository.findAllWithRates(currentUser.getId(), null, pageable);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Page&lt;Tip&gt; internalSearch(String search, Pageable pageable) {
<b class="nc">&nbsp;        return internalSearch(search, pageable, new LinkedMultiValueMap&lt;&gt;());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Page&lt;Tip&gt; internalSearch(String search, Pageable pageable, MultiValueMap&lt;String, String&gt; params) {
<b class="nc">&nbsp;        var currentUser = userService.getCurrentUser();</b>
<b class="nc">&nbsp;        var active = ofNullable(params.getFirst(&quot;active&quot;)).map(Boolean::parseBoolean).orElse(null);</b>
<b class="nc">&nbsp;        return repository.searchAllWithRates(search, currentUser.getId(), active, pageable);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Class&lt;Tip&gt; getEntityClass() {
<b class="fc">&nbsp;        return Tip.class;</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    private final CrudHooks&lt;Tip, TipDto, UUID&gt; hooks = new CrudHooks&lt;&gt;() {</b>
&nbsp;        @Override
&nbsp;        public void onAfterDelete(Tip model) {
<b class="nc">&nbsp;            StorageUtils.tryRemoveFileAsync(storage, model.getImage());</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void onAfterCreate(TipDto dto, Tip model) {
<b class="pc">&nbsp;            if (model.isActive()) {</b>
<b class="fc">&nbsp;                notificationService.sendAll(</b>
&nbsp;                        &quot;Nuevo consejo para ti&quot;,
&nbsp;                        &quot;Hemos agregado un nuevo tip que podr√≠a interesarte. Accede a la aplicaci√≥n para leerlo y aprender m√°s.&quot;
&nbsp;                );
&nbsp;            }
&nbsp;        }
&nbsp;    };
&nbsp;
&nbsp;    @PreAuthorize(&quot;isAuthenticated()&quot;)
&nbsp;    public List&lt;Tip&gt; top() {
<b class="nc">&nbsp;        return repository.topRating(3);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-02-21 14:48</div>
</div>
</body>
</html>
